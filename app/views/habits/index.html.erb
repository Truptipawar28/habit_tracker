<h1 class="text-2xl font-bold mb-4">My Habits</h1>

<%= link_to "New Habit", new_habit_path, class: "mt-4 inline-block bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" %>

<ul class="mt-6 space-y-4">
  <% @habits.each do |habit| %>
    <li class="bg-white p-4 rounded-lg shadow flex justify-between items-start gap-4">
      <div class="flex-1">
        <h2 class="text-xl font-semibold"><%= habit.title %></h2>
        <p class="text-gray-600 mt-1"><%= habit.description %></p>

        <div class="mt-2 text-sm text-gray-700">
          🏆 Current: <%= habit.current_streak %> |
          🥇 Longest: <%= habit.longest_streak %> |
          📊 Consistency: <%= habit.completion_rate %>%
        </div>

        <% if habit.habit_checkins.exists?(checkin_date: Date.today) %>
          <span class="mt-1 text-green-600">✅ Checked in today</span>
        <% else %>
          <span class="mt-1 text-red-500">⛔ Not yet</span>
        <% end %>

        <div class="mt-3">
          <%= form_with url: habit_checkins_path(habit_id: habit.id), method: :post, local: true do |f| %>
            <div class="flex items-center gap-2">
              <%= f.date_field :checkin_date, value: Date.current, name: "checkin_date", class: "border p-1 rounded" %>
              <%= f.submit "Mark Done", class: "bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" %>
            </div>
          <% end %>
        </div>

        <div class="mt-4 grid grid-cols-7 gap-2 text-center text-sm">
          <% start_date = Date.current.beginning_of_month %>
          <% end_date = Date.current.end_of_month %>
          <% (start_date..end_date).each do |day| %>
            <% done = habit.habit_checkins.exists?(checkin_date: day) %>
            <div class="w-8 h-8 flex items-center justify-center rounded-full 
              <%= done ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-500' %>
              <%= ' ring-2 ring-blue-500' if day == Date.today %>">
              <%= day.day %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="flex flex-col items-end gap-2">
        <% if habit.habit_checkins.exists?(checkin_date: Date.today) %>
          <%= button_to "Undo Check-in", habit_checkin_path(habit.habit_checkins.find_by(checkin_date: Date.today)), method: :delete, class: "text-yellow-600 underline" %>
        <% end %>

        <%= link_to "Edit", edit_habit_path(habit), class: "text-blue-500" %>
        <%= button_to "Delete", habit_path(habit), method: :delete, class: "text-red-500", form: { data: { turbo_confirm: "Are you sure?" } } %>
      </div>
    </li>
  <% end %>
</ul>
