<h1 class="text-2xl font-bold mb-6">My Habits</h1>

<div class="mb-4">
  <%= link_to "New Habit", new_habit_path, class: "bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" %>
</div>

<% today = Date.current %>
<% year = today.year %>
<% month = today.month %>
<% days = calendar_days(year, month) %>

<% @habits.each do |habit| %>
  <div class="bg-white shadow-md rounded p-4 mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h2 class="text-xl font-semibold"><%= habit.title %></h2>
        <p class="text-gray-600"><%= habit.description %></p>

        <div class="mt-2 text-sm">
          🧍 Current: <%= habit.current_streak %> |
          🏅 Longest: <%= habit.longest_streak %> |
          📊 Consistency: <%= number_to_percentage(habit.consistency, precision: 1) %>
        </div>

        <% if habit.checked_in_today? %>
          <div class="text-green-600 mt-1">✅ Checked in today</div>
        <% else %>
          <div class="text-red-500 mt-1">⛔ Not yet</div>
        <% end %>
      </div>

      <div class="flex space-x-3 text-sm">
        <% if habit.checked_in_today? %>
          <%= button_to "Undo Check-in", habit_checkin_path(habit.habit_checkins.find_by(checkin_date: today)),
                        method: :delete,
                        class: "text-yellow-600 hover:underline" %>
        <% end %>

        <%= link_to "Edit", edit_habit_path(habit), class: "text-blue-600 hover:underline" %>
        <%= link_to "Delete", habit_path(habit), method: :delete, data: { confirm: "Are you sure?" }, class: "text-red-600 hover:underline" %>
      </div>
    </div>

    <!-- Calendar Check-in Form -->
    <div class="mt-4 flex items-center space-x-2">
      <%= form_with url: habit_checkins_path(habit), method: :post, local: true do |f| %>
        <%= f.date_field :checkin_date, value: today, class: "border rounded px-2 py-1" %>
        <%= f.submit "Mark Done", class: "bg-green-500 text-white px-4 py-1 rounded hover:bg-green-600" %>
      <% end %>
    </div>

    <!-- Calendar Grid -->
    <div class="mt-4">
      <div class="grid grid-cols-7 gap-2 text-center text-sm text-gray-600">
        <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
          <div><%= day %></div>
        <% end %>
      </div>

      <div class="grid grid-cols-7 gap-2 text-center mt-2">
        <% days.each do |day| %>
          <% if day.month != month %>
            <div class="text-gray-300 py-2"> </div>
          <% else %>
            <% checked = habit.habit_checkins.any? { |c| c.checkin_date == day } %>
            <div class="py-2 rounded-full
                        <%= checked ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700' %>
                        <%= day > today ? 'opacity-30 cursor-not-allowed' : '' %>">
              <%= day.day %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
